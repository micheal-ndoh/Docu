# Database Design

## Overview

The application uses **PostgreSQL** as the database with **Prisma ORM** for type-safe database access.

## Database Schema

```prisma
// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL")
}

// NextAuth Models
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id            String       @id @default(cuid())
  name          String?
  email         String       @unique
  emailVerified DateTime?
  image         String?
  accounts      Account[]
  sessions      Session[]
  submissions   Submission[]
}

model Submission {
  id             String   @id @default(cuid())
  userId         String
  docusealId     Int      @unique
  status         String   @default("pending")
  submitterEmail String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([docusealId])
  @@index([submitterEmail])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}
```

## Entity Relationship Diagram

```mermaid
erDiagram
    User ||--o{ Account : has
    User ||--o{ Session : has
    User ||--o{ Submission : creates
    
    User {
        string id PK
        string email UK
        string name
        datetime emailVerified
        string image
    }
    
    Account {
        string id PK
        string userId FK
        string provider
        string providerAccountId
        string access_token
        string refresh_token
    }
    
    Session {
        string id PK
        string userId FK
        string sessionToken UK
        datetime expires
    }
    
    Submission {
        string id PK
        string userId FK
        int docusealId UK
        string status
        string submitterEmail
        datetime createdAt
        datetime updatedAt
    }
```

## Models Explained

### User Model

**Purpose**: Stores application users synced from Keycloak

**Fields**:
- `id` (CUID): Primary key, auto-generated by Prisma
- `email` (String, unique): User's email address (link to Keycloak)
- `name` (String, optional): User's display name
- `emailVerified` (DateTime, optional): Email verification timestamp
- `image` (String, optional): Profile image URL

**Relationships**:
- One-to-many with `Account` (OAuth accounts)
- One-to-many with `Session` (active sessions)
- One-to-many with `Submission` (created submissions)

**Indexes**:
- Primary key on `id`
- Unique index on `email`

### Account Model

**Purpose**: Stores OAuth account information (NextAuth.js)

**Fields**:
- `id` (CUID): Primary key
- `userId` (String): Foreign key to User
- `provider` (String): OAuth provider (e.g., "keycloak")
- `providerAccountId` (String): Keycloak user ID
- `access_token` (Text): OAuth access token
- `refresh_token` (Text): OAuth refresh token
- `expires_at` (Int): Token expiration timestamp
- `id_token` (Text): OpenID Connect ID token

**Relationships**:
- Many-to-one with `User`

**Constraints**:
- Unique on `[provider, providerAccountId]`
- Cascade delete when user is deleted

### Session Model

**Purpose**: Stores user sessions (NextAuth.js)

**Fields**:
- `id` (CUID): Primary key
- `sessionToken` (String, unique): Session identifier
- `userId` (String): Foreign key to User
- `expires` (DateTime): Session expiration

**Relationships**:
- Many-to-one with `User`

**Constraints**:
- Unique on `sessionToken`
- Cascade delete when user is deleted

### Submission Model

**Purpose**: Tracks document submissions created by users

**Fields**:
- `id` (CUID): Primary key
- `userId` (String): Foreign key to User (creator)
- `docusealId` (Int, unique): DocuSeal submission ID
- `status` (String): Submission status (pending, completed, etc.)
- `submitterEmail` (String): Email of the person signing
- `createdAt` (DateTime): Creation timestamp
- `updatedAt` (DateTime): Last update timestamp

**Relationships**:
- Many-to-one with `User`

**Indexes**:
- Primary key on `id`
- Unique index on `docusealId`
- Index on `userId` (for fast user queries)
- Index on `docusealId` (for DocuSeal lookups)
- Index on `submitterEmail` (for email searches)

**Constraints**:
- Cascade delete when user is deleted

## Data Flow

### User Creation Flow

```mermaid
flowchart TD
    Start[User Logs In] --> Check{User Exists?}
    Check -->|No| Create[Create User]
    Create --> GenID[Prisma Generates CUID]
    GenID --> Save[INSERT INTO User]
    Save --> CreateAccount[Create Account Record]
    CreateAccount --> SaveAccount[INSERT INTO Account]
    SaveAccount --> Done[User Created]
    
    Check -->|Yes| Fetch[SELECT FROM User]
    Fetch --> Done
    
    style Create fill:#fff3e0
    style GenID fill:#e8f5e9
    style Save fill:#e1f5ff
```

### Submission Creation Flow

```mermaid
flowchart TD
    Start[Create Submission] --> API[Call DocuSeal API]
    API --> Success{API Success?}
    Success -->|Yes| Extract[Extract submission_id]
    Extract --> SaveDB[INSERT INTO Submission]
    SaveDB --> Link[Link to User via userId]
    Link --> Done[Submission Created]
    
    Success -->|No| Error[Return Error]
    
    style API fill:#fce4ec
    style SaveDB fill:#e8f5e9
    style Link fill:#e1f5ff
```

## Database Operations

### Common Queries

#### Find User by Email
```typescript
const user = await prisma.user.findFirst({
  where: { email: 'user@example.com' }
});
```

#### Create User
```typescript
const user = await prisma.user.create({
  data: {
    email: 'user@example.com',
    name: 'John Doe',
  }
});
```

#### Get User's Submissions
```typescript
const submissions = await prisma.submission.findMany({
  where: { userId: 'user-id' },
  orderBy: { createdAt: 'desc' }
});
```

#### Create Submission
```typescript
const submission = await prisma.submission.create({
  data: {
    userId: 'user-id',
    docusealId: 123456,
    status: 'pending',
    submitterEmail: 'signer@example.com',
  }
});
```

## Migrations

### Running Migrations

```bash
# Generate Prisma client
npx prisma generate

# Create migration
npx prisma migrate dev --name description

# Apply migrations (production)
npx prisma migrate deploy

# Reset database (development only)
npx prisma migrate reset
```

### Migration History

Migrations are stored in `prisma/migrations/` directory.

## Indexes & Performance

### Indexed Columns

| Table | Column | Type | Purpose |
|-------|--------|------|---------|
| User | id | Primary | Unique identifier |
| User | email | Unique | Fast email lookups |
| Submission | id | Primary | Unique identifier |
| Submission | userId | Index | Fast user queries |
| Submission | docusealId | Unique | DocuSeal integration |
| Submission | submitterEmail | Index | Email searches |

### Query Optimization

```typescript
// ✅ Good: Uses index
const submissions = await prisma.submission.findMany({
  where: { userId: 'user-id' }
});

// ✅ Good: Uses unique index
const submission = await prisma.submission.findUnique({
  where: { docusealId: 123456 }
});

// ❌ Avoid: Full table scan
const submissions = await prisma.submission.findMany({
  where: { status: { contains: 'pending' } }
});
```

## Foreign Key Constraints

### User → Submission

```sql
ALTER TABLE "Submission" 
ADD CONSTRAINT "Submission_userId_fkey" 
FOREIGN KEY ("userId") 
REFERENCES "User"("id") 
ON DELETE CASCADE;
```

**Behavior**:
- When a user is deleted, all their submissions are deleted
- Cannot create submission with non-existent userId
- Ensures data integrity

### Critical: User ID Must Match

```typescript
// ❌ WRONG: Using Keycloak ID
await prisma.submission.create({
  data: {
    userId: 'keycloak-uuid', // Foreign key violation!
    docusealId: 123,
  }
});

// ✅ CORRECT: Using App User ID
await prisma.submission.create({
  data: {
    userId: user.id, // App user CUID
    docusealId: 123,
  }
});
```

## Database Connection

### Connection Pooling

Prisma automatically manages connection pooling:

```typescript
// src/db.ts
import { PrismaClient } from '@prisma/client';

export const db =
  global.prisma ||
  new PrismaClient({
    log: process.env.NODE_ENV === 'development' 
      ? ['query', 'info', 'warn', 'error'] 
      : ['error'],
  });

if (process.env.NODE_ENV !== 'production') {
  global.prisma = db;
}
```

### Environment Variables

```bash
# Connection string
DATABASE_URL="postgresql://user:password@localhost:5432/docu"

# Direct connection (for migrations)
DIRECT_DATABASE_URL="postgresql://user:password@localhost:5432/docu"
```

## Backup & Recovery

### Backup Strategy

```bash
# Backup database
pg_dump -U user -d docu > backup.sql

# Restore database
psql -U user -d docu < backup.sql
```

### Data Retention

- User data: Retained indefinitely
- Sessions: Auto-expire based on NextAuth config
- Submissions: Retained indefinitely
- Accounts: Retained while user exists

## Security

### Data Protection

- ✅ Foreign key constraints
- ✅ Unique constraints
- ✅ Cascade deletes
- ✅ Indexed queries
- ✅ Type-safe queries (Prisma)

### Sensitive Data

- Passwords: NOT stored (handled by Keycloak)
- Tokens: Stored encrypted in Account model
- Personal data: Email, name only

## Troubleshooting

### Common Issues

#### Foreign Key Violation
**Error**: `Foreign key constraint violated on the constraint: Submission_userId_fkey`  
**Cause**: Using Keycloak ID instead of app user ID  
**Solution**: Use `session.user.id` (app user ID)

#### Unique Constraint Violation
**Error**: `Unique constraint failed on the fields: (docusealId)`  
**Cause**: Trying to create duplicate submission  
**Solution**: Check if submission already exists

#### Connection Issues
**Error**: `Can't reach database server`  
**Cause**: Database not running or wrong connection string  
**Solution**: Verify DATABASE_URL and database status

## Best Practices

### Do's ✅
- Use Prisma's type-safe queries
- Always use indexes for frequent queries
- Use transactions for multi-step operations
- Handle foreign key constraints properly
- Use cascade deletes appropriately

### Don'ts ❌
- Don't use raw SQL unless necessary
- Don't skip migrations
- Don't ignore foreign key constraints
- Don't store sensitive data unencrypted
- Don't use SELECT * in production
